# ${CONFIG_HEADER}

# taken from https://element-hq.github.io/synapse/latest/reverse_proxy.html
# mixed with https://github.com/wmnnd/nginx-certbot/tree/master/etc/nginx/conf.d/nginx

# log_format vhosts '$host $remote_addr - $remote_user [$time_local] '
#                   '"$request" $status $body_bytes_sent '
#                   '"$http_referer" "$http_user_agent"';
# access_log /dev/stdout vhosts;

server {
    server_name ${DOMAIN};
    server_tokens off;

    listen 80;

    location /.well-known/acme-challenge/ {
       root /var/www/certbot;
    }

    location ~ ^/.well-known/(matrix|element)/ {
        root /var/www;
    }

    # XXX: is this right? or should auth.$DOMAIN be the issuer?
    location /.well-known/openid-configuration {
        proxy_pass http://mas:8080;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }

    location / {
        return 301 https://${DOLLAR}host${DOLLAR}request_uri;
    }
}

server {
    server_name ${DOMAIN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location = / {
	    return 302 https://${WEB_CLIENT_FQDN};
    }

    location ~ ^/.well-known/(matrix|element)/ {
        root /var/www;
    }

    # XXX: is this right? or should auth.$DOMAIN be the issuer?
    location /.well-known/openid-configuration {
        proxy_pass http://mas:8080;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${WEB_CLIENT_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location / {
        proxy_pass http://element-web;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${CALL_CLIENT_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location / {
        proxy_pass http://element-call:8080;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${MAS_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location / {
        proxy_pass http://mas:8080;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${LIVEKIT_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location / {
        proxy_pass http://livekit:7880;
        proxy_http_version 1.1;
        proxy_set_header Upgrade ${DOLLAR}http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host ${DOLLAR}host;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${LIVEKIT_JWT_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    location / {
        proxy_pass http://livekit-jwt:8080;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }
}

server {
    server_name ${HOMESERVER_FQDN};
    server_tokens off;

    include /etc/nginx/conf.d/include/ssl.conf;

    # For the federation port
    listen 8448 ssl default_server;
    listen [::]:8448 ssl default_server;

    location = / {
	    return 302 https://${WEB_CLIENT_FQDN};
    }

    location ~ ^/.well-known/(matrix|element)/ {
        root /var/www;
    }

    location ~ ^/metrics(.*)${DOLLAR} {
        proxy_pass http://hookshot:9001$1${DOLLAR}is_args${DOLLAR}args;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;
    }

    location ~ ^/v1(.*)${DOLLAR} {
        proxy_pass http://hookshot:9001$1${DOLLAR}is_args${DOLLAR}args;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;
    }

    location ~ ^/widgetapi(.*)${DOLLAR} {
        proxy_pass http://hookshot:9002$1${DOLLAR}is_args${DOLLAR}args;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;
    }

    location ~ ^/(webhook|hookshot) {
        proxy_pass http://hookshot:9000;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;
    }

    # XXX: is this right? or should auth.$DOMAIN be the issuer?
    location /.well-known/openid-configuration {
        proxy_pass http://mas:8080;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }

    location ~ ^/_matrix/identity {
        proxy_pass http://sydent:8090;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }

    # pass auth to MAS
    location ~ ^/_matrix/client/(.*)/(login|logout|refresh) {
        proxy_pass http://mas:8080;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
    }

    location ~ ^/_matrix/client/(r0|v3)/sync${DOLLAR} {
        proxy_pass http://synapse-generic-worker-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3)/events${DOLLAR} {
        proxy_pass http://synapse-generic-worker-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3)/initialSync${DOLLAR} {
        proxy_pass http://synapse-generic-worker-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/v1/media/ {
        proxy_pass http://synapse-media-repository-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;

        client_max_body_size ${MAX_UPLOAD_SIZE};
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3)/rooms/[^/]+/initialSync${DOLLAR} {
        proxy_pass http://synapse-generic-worker-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/.*/account_data {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/rooms/.*/receipt {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/rooms/.*/read_markers {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/typing {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/pushrules/ {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/presence/ {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/sendToDevice/ {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/.*/tags {
        proxy_pass http://synapse-stream-writer:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
    }

   
    location ~ ^/_matrix/federation/v1/media/ {
        proxy_pass http://synapse-media-repository-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;

        client_max_body_size ${MAX_UPLOAD_SIZE};
    }

    location ~ ^/_matrix/media/ {
        proxy_pass http://synapse-media-repository-1:8035;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        
        client_max_body_size ${MAX_UPLOAD_SIZE};
    }

    location ~ ^(/_synapse/client|/_synapse/admin|/health) {
        # note: do not add a path (even a single /) after the port in `proxy_pass`,
        # otherwise nginx will canonicalize the URI and cause signature verification errors.
        proxy_pass http://synapse:8008;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;

        # Nginx by default only allows file uploads up to 1M in size
        # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
        client_max_body_size ${MAX_UPLOAD_SIZE};
    }

    location / {
        proxy_pass http://synapse:8008;
        proxy_set_header X-Forwarded-For ${DOLLAR}remote_addr;
        proxy_set_header X-Forwarded-Proto ${DOLLAR}scheme;
        proxy_set_header Host ${DOLLAR}host;

        # Nginx by default only allows file uploads up to 1M in size
        # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
        client_max_body_size ${MAX_UPLOAD_SIZE};
    }

    # Synapse responses may be chunked, which is an HTTP/1.1 feature.
    proxy_http_version 1.1;
}
